<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin - Script Manager</title><style>
*{box-sizing:border-box;margin:0}body{background:#0b0b0b;color:#eaeaea;font-family:'Courier New',monospace;padding:20px}.container{max-width:800px;margin:0 auto}h1{color:#00f2ea;border-left:4px solid #00f2ea;padding-left:15px;margin-bottom:30px}.logout-bar{display:flex;justify-content:space-between;align-items:center;background:#1a1a1a;padding:10px 20px;border-radius:50px;margin-bottom:20px;border:1px solid #00f2ea40}.logout-btn{background:#ff4444;color:white;border:none;padding:8px 20px;border-radius:50px;cursor:pointer;font-weight:bold;width:auto}.logout-btn:hover{background:#cc0000}.admin-card{background:#111;border:1px solid #2a2a2a;border-radius:16px;padding:25px;margin-bottom:25px;box-shadow:0 8px 0 #050505}h2{color:#00f2ea;margin-bottom:20px;font-size:1.3rem;border-bottom:1px dashed #2e2e2e;padding-bottom:8px}label{display:block;margin:15px 0 5px;color:#aaa;font-size:.9rem;text-transform:uppercase;letter-spacing:1px}input,textarea{width:100%;padding:12px;background:#1a1a1a;border:1px solid #3a3a3a;color:#fff;border-radius:8px;font-family:'Courier New',monospace;font-size:.9rem}input:focus,textarea:focus{border-color:#00f2ea;outline:none;box-shadow:0 0 10px #00f2ea66}textarea{min-height:120px;resize:vertical}.checkbox-group{display:flex;align-items:center;gap:10px;margin:20px 0;padding:10px;background:#1a1a1a;border-radius:8px}.checkbox-group input{width:auto;accent-color:#00f2ea}.feature-tags{display:flex;flex-wrap:wrap;gap:10px;margin:20px 0;padding:10px;background:#1a1a1a;border-radius:8px}.feature-tag{background:#1a2a2a;color:#9cfff8;padding:8px 16px;border-radius:30px;font-size:.8rem;border:1px solid #00f2ea40;cursor:pointer;transition:all .2s}.feature-tag:hover{transform:translateY(-2px);border-color:#00f2ea}.feature-tag.selected{background:#00f2ea;color:#000;border-color:#00f2ea;box-shadow:0 0 15px #00f2ea}.key-system-selector{background:#1a2a2a;border-radius:8px;padding:15px;margin:20px 0}.key-option{display:flex;align-items:center;gap:10px;margin:10px 0;padding:12px;background:#0f1a1f;border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent}.key-option:hover{background:#1a2f3a}.key-option.selected{background:#00f2ea20;border:1px solid #00f2ea}.key-option input[type="radio"]{width:auto;accent-color:#00f2ea}.key-badge{padding:4px 12px;border-radius:30px;font-size:.8rem;min-width:80px;text-align:center}.key-badge.keyless{background:#4a4a4a;color:#fff}.key-badge.key1{background:#00aa00;color:#fff}.key-badge.key2{background:#ffaa00;color:#000}.key-badge.key3{background:#ff4444;color:#fff}.linkvertise-config{background:#0f1a2a;border-radius:8px;padding:20px;margin:20px 0;border:1px solid #00f2ea40}.linkvertise-config h3{color:#00f2ea;margin-bottom:15px}.redirect-url-container{background:#1a2a2a;border-radius:8px;padding:20px;margin:10px 0 20px;border:1px solid #ff4444;display:none}.redirect-url-container h3{color:#ff4444;margin-bottom:15px}.redirect-url-container label{color:#ff8888}.roblox-search-card{background:#1a2f3a;border:2px solid #00f2ea;border-radius:16px;padding:25px;margin:20px 0;box-shadow:0 0 30px #00f2ea33}.roblox-search-card h3{color:#00f2ea;margin-bottom:15px;font-size:1.2rem}.search-row{display:flex;gap:10px;margin-bottom:15px}.search-row input{flex:2;padding:15px;font-size:1rem;background:#0f1a1f;border:2px solid #00f2ea40}.search-row button{width:auto;margin:0;padding:15px 25px}.search-results{max-height:400px;overflow-y:auto;background:#0f1a1f;border-radius:12px;padding:10px;margin:15px 0;border:1px solid #00f2ea40}.game-item{display:flex;align-items:center;gap:15px;padding:15px;margin:8px 0;background:#1a2a2a;border-radius:10px;cursor:pointer;border:1px solid transparent;transition:all .2s}.game-item:hover{background:#2a3a3a;border-color:#00f2ea;transform:translateX(5px)}.game-item img{width:60px;height:60px;border-radius:10px;object-fit:cover;border:2px solid #00f2ea40}.game-item-info{flex:1}.game-item-info h4{color:#00f2ea;margin-bottom:5px}.game-item-stats{display:flex;gap:15px;color:#aaa;font-size:.85rem}.game-item-playing{color:#00f2ea}.game-item-visits{color:#ffaa00}.selected-game-preview{background:#1a2a2a;border-radius:12px;padding:20px;margin:20px 0;border:2px solid #00f2ea;display:flex;gap:20px;flex-wrap:wrap}.selected-game-preview img{width:120px;height:120px;border-radius:16px;border:3px solid #00f2ea;object-fit:cover}.selected-game-details{flex:1}.selected-game-details h3{color:#00f2ea;margin-bottom:10px}.selected-game-desc{color:#aaa;margin-bottom:15px;line-height:1.5}.selected-game-stats{display:flex;gap:25px;margin:15px 0;flex-wrap:wrap}.stat-box{background:#0f1a1f;padding:12px 20px;border-radius:10px;border-left:3px solid #00f2ea}.stat-box .label{color:#888;font-size:.8rem}.stat-box .value{color:#00f2ea;font-size:1.2rem;font-weight:bold}.use-game-btn{background:#00f2ea;border:none;padding:15px;border-radius:50px;width:100%;font-weight:bold;cursor:pointer;margin-top:10px}.use-game-btn:hover{background:#00d4cc;transform:scale(1.02)}button{background:#00f2ea;color:#000;border:0;padding:14px 25px;border-radius:50px;font-weight:700;cursor:pointer;font-size:1rem;margin-top:10px;width:100%;transition:all .2s;border:1px solid #4afff0}button:hover{background:#00d4cc;transform:scale(1.02);box-shadow:0 0 20px #00f2ea}button.delete{background:#ff4444;color:#fff;border:1px solid #ff8888;width:auto;padding:8px 15px}button.delete:hover{background:#cc0000}button.edit{background:#ffaa00;color:#000;border:1px solid #ffcc00;width:auto;padding:8px 15px}button.edit:hover{background:#ff8800}.script-item{background:#1a1a1a;border-left:3px solid #00f2ea;padding:15px;margin:15px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.script-info{flex:1}.script-info h3{color:#00f2ea;margin-bottom:5px;font-size:1.1rem;display:flex;align-items:center;gap:10px}.script-thumb{width:40px;height:40px;border-radius:8px;object-fit:cover}.script-info p{color:#888;font-size:.8rem;line-height:1.5;margin:5px 0}.script-meta{display:flex;gap:15px;margin-top:8px;flex-wrap:wrap}.script-actions{display:flex;gap:10px}.status-badge{padding:4px 12px;border-radius:30px;font-size:.7rem;background:#00f2ea20;color:#00f2ea;display:inline-block}.admin-badge{background:#ff4444;color:white;padding:2px 8px;border-radius:30px;font-size:.6rem;margin-left:5px}.roblox-badge{background:#00f2ea;color:#000;padding:2px 8px;border-radius:30px;font-size:.6rem;margin-left:5px;font-weight:bold}.status-message{padding:10px;border-radius:8px;margin-bottom:20px;text-align:center}.edit-mode{background:#ffaa0020;border:2px solid #ffaa00;padding:10px;border-radius:8px;margin-bottom:20px;text-align:center}.edit-mode span{color:#ffaa00;font-weight:bold}
</style></head><body>
<div class="container">
  <div class="logout-bar">
    <span>ğŸ”’ <strong>Admin Panel</strong> Â· Script Manager</span>
    <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
  </div>
  
  <!-- STATUS MESSAGE -->
  <div id="statusMessage" style="margin-bottom:20px;"></div>
  
  <!-- EDIT MODE INDICATOR -->
  <div id="editModeIndicator" class="edit-mode" style="display: none;">
    <span>âœï¸ EDIT MODE</span> - You are editing a script
  </div>
  
  <!-- ROBLOX GAME SEARCH CARD (ADMIN ONLY) -->
  <div class="roblox-search-card">
    <h3>ğŸ® Roblox Game Search</h3>
    <p style="color:#aaa; margin-bottom:15px;">Search any Roblox game to auto-fill details (player counts update every 60 seconds)</p>
    
    <div class="search-row">
      <input type="text" id="robloxSearch" placeholder="Search for a game (e.g., Adopt Me, Blox Fruits, Murder Mystery 2)" value="Adopt Me">
      <button onclick="searchRobloxGame()" style="background:#00f2ea;">ğŸ” Search</button>
    </div>
    
    <!-- SEARCH RESULTS -->
    <div id="searchResults" class="search-results" style="display:none;"></div>
    
    <!-- SELECTED GAME PREVIEW -->
    <div id="selectedGamePreview" class="selected-game-preview" style="display:none;">
      <img id="selectedGameThumb" src="" alt="Game thumbnail">
      <div class="selected-game-details">
        <h3 id="selectedGameName"></h3>
        <div id="selectedGameDesc" class="selected-game-desc"></div>
        <div class="selected-game-stats">
          <div class="stat-box">
            <div class="label">ğŸ‘¥ CURRENT PLAYERS</div>
            <div class="value" id="selectedGamePlaying">0</div>
          </div>
          <div class="stat-box">
            <div class="label">ğŸ“Š TOTAL VISITS</div>
            <div class="value" id="selectedGameVisits">0</div>
          </div>
        </div>
        <button class="use-game-btn" onclick="useSelectedGame()">ğŸ“‹ Use This Game for Script</button>
      </div>
    </div>
  </div>
  
  <!-- MAIN ADMIN CARD -->
  <div class="admin-card">
    <h2 id="formTitle">ğŸ“ Add New Script</h2>
    <input type="hidden" id="editingScriptId">
    <input type="hidden" id="gameUniverseId" value="">
    
    <label>Script Name</label>
    <input type="text" id="scriptName" placeholder="e.g., ğŸ”ª MURDER MYSTERY 2">

    <label>Script Description (optional)</label>
    <textarea id="scriptDescription" placeholder="Describe what this script does..."></textarea>

    <!-- SIMPLE IMAGE URL (since we're using Roblox thumbnails) -->
    <div style="margin:15px 0;">
      <label>Game Thumbnail (auto-filled from Roblox)</label>
      <input type="url" id="imageUrl" placeholder="Will be auto-filled from search">
      <input type="hidden" id="imageData" value="">
    </div>

    <label>Loadstring Code</label>
    <textarea id="scriptCode" placeholder='loadstring(game:HttpGet("URL"))()'></textarea>

    <!-- BLURRED CHECKBOX -->
    <div class="checkbox-group">
      <input type="checkbox" id="scriptBlurred" onchange="toggleRedirectUrlField()">
      <label>ğŸ”’ Require verification (blurred)</label>
    </div>

    <!-- REDIRECT URL -->
    <div id="redirectUrlContainer" class="redirect-url-container">
      <h3>ğŸ”’ ADMIN ONLY - Redirect URL</h3>
      <label>Required for blurred scripts</label>
      <input type="url" id="scriptRedirectUrl" placeholder="https://openinapp.link/xxx">
      <p style="color:#ff8888; font-size:0.8rem; margin-top:8px;">â±ï¸ 5-second timer then redirect here</p>
    </div>

    <label>ğŸ”‘ Key System Type</label>
    <div class="key-system-selector">
      <div class="key-option" onclick="selectKeySystem('keyless')" id="keyless-option">
        <input type="radio" name="keySystem" value="keyless" checked><span class="key-badge keyless">ğŸ”“ KEYLESS</span>
      </div>
      <div class="key-option" onclick="selectKeySystem('key1')" id="key1-option">
        <input type="radio" name="keySystem" value="key1"><span class="key-badge key1">ğŸ”‘ 1 KEY</span>
      </div>
      <div class="key-option" onclick="selectKeySystem('key2')" id="key2-option">
        <input type="radio" name="keySystem" value="key2"><span class="key-badge key2">ğŸ”‘ğŸ”‘ 2 KEYS</span>
      </div>
      <div class="key-option" onclick="selectKeySystem('key3')" id="key3-option">
        <input type="radio" name="keySystem" value="key3"><span class="key-badge key3">ğŸ”‘ğŸ”‘ğŸ”‘ 3 KEYS</span>
      </div>
    </div>

    <div id="linkvertiseLinks" style="display:none;">
      <div class="linkvertise-config">
        <h3>ğŸ”— Linkvertise Links</h3>
        <div id="linkvertiseFields"></div>
        <p style="color:#aaa; font-size:0.8rem;">Example: https://link-to.net/1446949/123456/dynamic</p>
      </div>
    </div>

    <label>Features</label>
    <div class="feature-tags" id="featureTags">
      <span class="feature-tag" data-feature="ğŸ® Bloxfruit">ğŸ® Bloxfruit</span>
      <span class="feature-tag" data-feature="ğŸ§  Brainrot">ğŸ§  Brainrot</span>
      <span class="feature-tag" data-feature="ğŸŒŠ Tsunami">ğŸŒŠ Tsunami</span>
      <span class="feature-tag" data-feature="âš”ï¸ Rivals">âš”ï¸ Rivals</span>
      <span class="feature-tag" data-feature="ğŸ”« Arsenal">ğŸ”« Arsenal</span>
      <span class="feature-tag" data-feature="ğŸŸ Fisch">ğŸŸ Fisch</span>
      <span class="feature-tag" data-feature="ğŸ¾ Adopt Me">ğŸ¾ Adopt Me</span>
      <span class="feature-tag" data-feature="ğŸŒ± Garden">ğŸŒ± Garden</span>
    </div>

    <button onclick="saveScript()" id="saveButton">ğŸ’¾ Save & Auto-Commit</button>
    <button onclick="cancelEdit()" style="background:#666;margin-top:5px;" id="cancelButton">âœ• Cancel</button>
  </div>

  <!-- CURRENT SCRIPTS LIST -->
  <div class="admin-card">
    <h2>ğŸ“‹ Current Scripts</h2>
    <div id="scriptsList">Loading...</div>
  </div>
</div>

<script>
// ==================== AUTH CHECK ====================
async function checkAuth() {
  try {
    const response = await fetch('/api/verify');
    const data = await response.json();
    if (!data.authenticated) {
      window.location.href = '/login.html';
    }
  } catch {
    window.location.href = '/login.html';
  }
}

// ==================== LOGOUT ====================
async function logout() {
  await fetch('/api/logout', { method: 'POST' });
  window.location.href = '/login.html';
}

// ==================== CONFIG ====================
const ADMIN_PASSWORD = 'noobie123admin';
const API_URL = '/api/commit';
const ROBLOX_PROXY = 'https://api.roproxy.com/';

let selectedFeatures = [], currentScripts = [], selectedKeySystem = 'keyless';
let playerCountInterval = null;
let selectedGameData = null;

// ==================== ROBLOX API FUNCTIONS ====================
async function searchRobloxGame() {
  const query = document.getElementById('robloxSearch').value.trim();
  if (!query) { alert('Enter a search term'); return; }
  
  showStatus('ğŸ” Searching Roblox games...');
  
  try {
    const response = await fetch(`${ROBLOX_PROXY}games.roblox.com/v1/games/list?keyword=${encodeURIComponent(query)}&limit=10`);
    const data = await response.json();
    
    if (!data.games || data.games.length === 0) {
      showStatus('âŒ No games found', true);
      return;
    }
    
    displaySearchResults(data.games);
  } catch (error) {
    console.error('Search error:', error);
    showStatus('âŒ Failed to search Roblox', true);
  }
}

function displaySearchResults(games) {
  const resultsDiv = document.getElementById('searchResults');
  resultsDiv.style.display = 'block';
  
  let html = '';
  games.forEach(game => {
    const playing = game.playing || 0;
    const visits = game.visits || 0;
    
    html += `
      <div class="game-item" onclick='selectGame(${JSON.stringify(game)})'>
        <img src="https://www.roblox.com/asset/?id=${game.rootPlaceId}" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2260%22%20height%3D%2260%22%3E%3Crect%20width%3D%2260%22%20height%3D%2260%22%20fill%3D%22%23333%22%2F%3E%3Ctext%20x%3D%2210%22%20y%3D%2240%22%20fill%3D%22%2300f2ea%22%20font-size%3D%2220%22%3EğŸ®%3C%2Ftext%3E%3C%2Fsvg%3E'">
        <div class="game-item-info">
          <h4>${game.name}</h4>
          <div class="game-item-stats">
            <span class="game-item-playing">ğŸ‘¥ ${playing.toLocaleString()} playing</span>
            <span class="game-item-visits">ğŸ“Š ${visits.toLocaleString()} visits</span>
          </div>
        </div>
      </div>
    `;
  });
  
  resultsDiv.innerHTML = html;
}

async function selectGame(game) {
  showStatus(`ğŸ“¡ Fetching detailed game info...`);
  
  try {
    // Get detailed game info with universe ID
    const response = await fetch(`${ROBLOX_PROXY}games.roblox.com/v1/games?universeIds=${game.universeId}`);
    const data = await response.json();
    const details = data.data[0];
    
    // Get game thumbnail
    const thumbResponse = await fetch(`${ROBLOX_PROXY}thumbnails.roblox.com/v1/games/icons?universeIds=${game.universeId}&size=256x256&format=Png`);
    const thumbData = await thumbResponse.json();
    const thumbUrl = thumbData.data[0]?.imageUrl || '';
    
    selectedGameData = {
      universeId: game.universeId,
      name: details.name,
      description: details.description || 'No description available',
      playing: details.playing || 0,
      visits: details.visits || 0,
      thumbUrl
    };
    
    // Update preview
    document.getElementById('selectedGameName').textContent = details.name;
    document.getElementById('selectedGameDesc').textContent = details.description || 'No description available';
    document.getElementById('selectedGamePlaying').textContent = (details.playing || 0).toLocaleString();
    document.getElementById('selectedGameVisits').textContent = (details.visits || 0).toLocaleString();
    document.getElementById('selectedGameThumb').src = thumbUrl;
    document.getElementById('selectedGamePreview').style.display = 'flex';
    document.getElementById('searchResults').style.display = 'none';
    
    // Start auto-refresh for player count
    startPlayerCountRefresh(game.universeId);
    
    showStatus('âœ… Game loaded! Auto-refreshing player count every 60 seconds');
  } catch (error) {
    console.error('Game fetch error:', error);
    showStatus('âŒ Failed to load game details', true);
  }
}

async function refreshPlayerCount(universeId) {
  if (!universeId) return;
  
  try {
    const response = await fetch(`${ROBLOX_PROXY}games.roblox.com/v1/games?universeIds=${universeId}`);
    const data = await response.json();
    const playing = data.data[0]?.playing || 0;
    
    document.getElementById('selectedGamePlaying').textContent = playing.toLocaleString();
  } catch (error) {
    console.error('Player count refresh error:', error);
  }
}

function startPlayerCountRefresh(universeId) {
  if (playerCountInterval) clearInterval(playerCountInterval);
  
  // Update every 60 seconds
  playerCountInterval = setInterval(() => {
    refreshPlayerCount(universeId);
  }, 60000);
}

function useSelectedGame() {
  if (!selectedGameData) return;
  
  // Auto-fill script name
  document.getElementById('scriptName').value = selectedGameData.name;
  
  // Auto-fill description
  document.getElementById('scriptDescription').value = selectedGameData.description;
  
  // Auto-fill image URL
  document.getElementById('imageUrl').value = selectedGameData.thumbUrl;
  document.getElementById('imageData').value = selectedGameData.thumbUrl;
  
  // Save universe ID for future reference (optional)
  document.getElementById('gameUniverseId').value = selectedGameData.universeId;
  
  showStatus('âœ… Game info applied to form!');
}

// ==================== UI FUNCTIONS ====================
function showStatus(msg, isError) {
  let el = document.getElementById('statusMessage');
  el.innerHTML = `<div style="background:${isError?'#ff444420':'#00f2ea20'};border:1px solid ${isError?'#ff4444':'#00f2ea'};color:${isError?'#ff8888':'#00f2ea'};padding:10px;border-radius:8px;">${msg}</div>`;
  setTimeout(() => el.innerHTML = '', 5000);
}

function toggleRedirectUrlField() {
  let c = document.getElementById('scriptBlurred').checked;
  document.getElementById('redirectUrlContainer').style.display = c ? 'block' : 'none';
}

function selectKeySystem(v) {
  selectedKeySystem = v;
  document.querySelectorAll('.key-option').forEach(o => o.classList.remove('selected'));
  document.getElementById(v+'-option').classList.add('selected');
  document.querySelector(`input[name="keySystem"][value="${v}"]`).checked = true;
  
  let div = document.getElementById('linkvertiseLinks'), fields = document.getElementById('linkvertiseFields');
  if (v !== 'keyless') {
    div.style.display = 'block';
    let html = '';
    for (let i = 1; i <= parseInt(v.replace('key','')); i++) 
      html += `<label>Key ${i} URL</label><input type="url" id="key${i}Link" placeholder="https://link-to.net/1446949/xxx">`;
    fields.innerHTML = html;
  } else div.style.display = 'none';
}

// ==================== FEATURE TAGS ====================
document.querySelectorAll('.feature-tag').forEach(t => {
  t.onclick = () => {
    t.classList.toggle('selected');
    let f = t.dataset.feature;
    selectedFeatures.includes(f) ? 
      selectedFeatures = selectedFeatures.filter(x => x !== f) : 
      selectedFeatures.push(f);
  };
});

// ==================== CANCEL EDIT ====================
function cancelEdit() {
  document.getElementById('scriptName').value = '';
  document.getElementById('scriptDescription').value = '';
  document.getElementById('scriptCode').value = '';
  document.getElementById('scriptBlurred').checked = false;
  document.getElementById('scriptRedirectUrl').value = '';
  document.getElementById('editingScriptId').value = '';
  document.getElementById('gameUniverseId').value = '';
  document.getElementById('imageUrl').value = '';
  document.getElementById('imageData').value = '';
  document.getElementById('redirectUrlContainer').style.display = 'none';
  document.getElementById('selectedGamePreview').style.display = 'none';
  document.getElementById('formTitle').innerHTML = 'ğŸ“ Add New Script';
  document.getElementById('saveButton').innerHTML = 'ğŸ’¾ Save & Auto-Commit';
  document.getElementById('editModeIndicator').style.display = 'none';
  
  if (playerCountInterval) {
    clearInterval(playerCountInterval);
    playerCountInterval = null;
  }
  
  selectedKeySystem = 'keyless';
  document.querySelectorAll('.key-option').forEach(o => o.classList.remove('selected'));
  document.getElementById('keyless-option').classList.add('selected');
  document.querySelector('input[name="keySystem"][value="keyless"]').checked = true;
  selectedFeatures = [];
  document.querySelectorAll('.feature-tag').forEach(t => t.classList.remove('selected'));
  document.getElementById('linkvertiseLinks').style.display = 'none';
}

// ==================== LOAD SCRIPTS ====================
async function loadScripts() {
  try {
    let r = await fetch('scripts.json?t='+Date.now()), d = await r.json();
    currentScripts = d.scripts || [];
    let list = document.getElementById('scriptsList');
    if (!currentScripts.length) { list.innerHTML = '<p>No scripts</p>'; return; }
    list.innerHTML = currentScripts.map(s => {
      let key = '';
      if (s.keySystem === 'key1') key = '<span class="key-badge key1">ğŸ”‘1</span>';
      else if (s.keySystem === 'key2') key = '<span class="key-badge key2">ğŸ”‘ğŸ”‘2</span>';
      else if (s.keySystem === 'key3') key = '<span class="key-badge key3">ğŸ”‘ğŸ”‘ğŸ”‘3</span>';
      
      let robloxBadge = s.universeId ? '<span class="roblox-badge">ğŸ® Roblox</span>' : '';
      
      return `<div class="script-item">
        <div class="script-info">
          <h3>${s.name} ${robloxBadge}</h3>
          ${s.description ? `<p>ğŸ“ ${s.description}</p>` : ''}
          <p>${s.code.substring(0,50)}...</p>
          <div class="script-meta">
            <span class="status-badge">${s.blurred?'ğŸ”’Blurred':'âœ…Public'}</span>
            ${key}
          </div>
        </div>
        <div class="script-actions">
          <button class="edit" onclick="editScript('${s.id}')">âœï¸</button>
          <button class="delete" onclick="deleteScript('${s.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`;
    }).join('');
  } catch(e) { 
    document.getElementById('scriptsList').innerHTML = '<p style="color:#ff4444;">Error loading scripts</p>';
  }
}

// ==================== EDIT SCRIPT ====================
function editScript(id) {
  let s = currentScripts.find(x => x.id === id); if (!s) return;
  document.getElementById('scriptName').value = s.name;
  document.getElementById('scriptDescription').value = s.description || '';
  document.getElementById('scriptCode').value = s.code;
  document.getElementById('scriptBlurred').checked = s.blurred || false;
  document.getElementById('scriptRedirectUrl').value = s.redirectUrl || '';
  document.getElementById('editingScriptId').value = s.id;
  document.getElementById('gameUniverseId').value = s.universeId || '';
  document.getElementById('imageUrl').value = s.image || '';
  document.getElementById('imageData').value = s.image || '';
  
  document.getElementById('redirectUrlContainer').style.display = s.blurred ? 'block' : 'none';
  
  selectKeySystem(s.keySystem || 'keyless');
  selectedFeatures = s.features || [];
  document.querySelectorAll('.feature-tag').forEach(t => t.classList.toggle('selected', selectedFeatures.includes(t.dataset.feature)));
  if (s.keyLinks) for (let i=1; i<=s.keyLinks.length; i++) {
    let inp = document.getElementById(`key${i}Link`);
    if (inp) inp.value = s.keyLinks[i-1];
  }
  document.getElementById('formTitle').innerHTML = 'âœï¸ Edit Script';
  document.getElementById('saveButton').innerHTML = 'âœï¸ Update & Auto-Commit';
  document.getElementById('editModeIndicator').style.display = 'block';
}

// ==================== GITHUB API via Serverless ====================
async function commitToGitHub(scriptData, isEdit, sendWebhook = true) {
  try {
    let fullData = {
      siteTitle: "lokus hub scripts", 
      visitorCount: 1842,
      linkvertise: { 
        userId: "1446949", 
        callbackUrl: "https://linkvertise-callback-production.up.railway.app/callback" 
      },
      scripts: currentScripts,
      lastUpdated: new Date().toISOString().split('T')[0]
    };
    
    let r = await fetch(API_URL, {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer ' + ADMIN_PASSWORD, 
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify({
        content: btoa(unescape(encodeURIComponent(JSON.stringify(fullData, null, 2)))),
        message: isEdit ? `âœï¸ Updated: ${scriptData.name}` : `âœ¨ Added: ${scriptData.name}`,
        filename: 'scripts.json',
        scriptData: sendWebhook ? scriptData : null,
        isEdit: isEdit
      })
    });
    
    let res = await r.json();
    if (!r.ok) throw new Error(res.error || 'Commit failed');
    
    showStatus(`âœ… ${isEdit ? 'Updated' : 'Added'}! Vercel deploying...`);
    return true;
  } catch(e) { 
    showStatus(`âŒ Error: ${e.message}`, true); 
    return false; 
  }
}

// ==================== SAVE SCRIPT ====================
async function saveScript() {
  let name = document.getElementById('scriptName').value;
  let description = document.getElementById('scriptDescription').value;
  let code = document.getElementById('scriptCode').value;
  let blurred = document.getElementById('scriptBlurred').checked;
  let redirect = document.getElementById('scriptRedirectUrl').value;
  let editId = document.getElementById('editingScriptId').value;
  let image = document.getElementById('imageData').value;
  let universeId = document.getElementById('gameUniverseId').value;
  
  if (!name || !code) { alert('Fill all fields'); return; }
  if (blurred && !redirect) { alert('Redirect URL required for blurred scripts'); return; }
  
  let keyLinks = [];
  if (selectedKeySystem !== 'keyless') {
    for (let i=1; i<=parseInt(selectedKeySystem.replace('key','')); i++) {
      let link = document.getElementById(`key${i}Link`)?.value;
      if (!link) { alert(`Enter Key ${i} URL`); return; }
      keyLinks.push(link);
    }
  }
  
  let scriptData = {
    id: editId || name.toLowerCase().replace(/[^a-z0-9]/g,'') + Date.now(),
    name, description, code, blurred, redirectUrl: redirect,
    image: image || null,
    universeId: universeId || null,
    keySystem: selectedKeySystem, keyLinks, features: [...selectedFeatures]
  };
  
  if (editId) {
    let idx = currentScripts.findIndex(s => s.id === editId);
    if (idx !== -1) currentScripts[idx] = scriptData;
  } else currentScripts.push(scriptData);
  
  if (await commitToGitHub(scriptData, !!editId, true)) {
    displayScripts();
    cancelEdit();
  }
}

// ==================== DELETE SCRIPT ====================
async function deleteScript(id) {
  if (!confirm('Delete this script?')) return;
  
  let script = currentScripts.find(s => s.id === id);
  currentScripts = currentScripts.filter(s => s.id !== id);
  
  if (await commitToGitHub(script, false, false)) {
    displayScripts();
  }
}

// ==================== DISPLAY HELPER ====================
function displayScripts() {
  let list = document.getElementById('scriptsList');
  if (!currentScripts.length) { list.innerHTML = '<p>No scripts</p>'; return; }
  list.innerHTML = currentScripts.map(s => {
    let key = '';
    if (s.keySystem === 'key1') key = '<span class="key-badge key1">ğŸ”‘1</span>';
    else if (s.keySystem === 'key2') key = '<span class="key-badge key2">ğŸ”‘ğŸ”‘2</span>';
    else if (s.keySystem === 'key3') key = '<span class="key-badge key3">ğŸ”‘ğŸ”‘ğŸ”‘3</span>';
    
    let robloxBadge = s.universeId ? '<span class="roblox-badge">ğŸ® Roblox</span>' : '';
    
    return `<div class="script-item">
      <div class="script-info">
        <h3>${s.name} ${robloxBadge}</h3>
        ${s.description ? `<p>ğŸ“ ${s.description}</p>` : ''}
        <p>${s.code.substring(0,50)}...</p>
        <div class="script-meta">
          <span class="status-badge">${s.blurred?'ğŸ”’Blurred':'âœ…Public'}</span>
          ${key}
        </div>
      </div>
      <div class="script-actions">
        <button class="edit" onclick="editScript('${s.id}')">âœï¸</button>
        <button class="delete" onclick="deleteScript('${s.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

// ==================== INIT ====================
checkAuth();
loadScripts();

// Auto-search Adopt Me on load
setTimeout(() => {
  document.getElementById('robloxSearch').value = 'Adopt Me';
  searchRobloxGame();
}, 500);
</script></body></html>
