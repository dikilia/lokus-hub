<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin - Script Manager</title><style>
*{box-sizing:border-box;margin:0}body{background:#0b0b0b;color:#eaeaea;font-family:'Courier New',monospace;padding:20px;transition:all .3s ease}.container{max-width:1000px;margin:0 auto}h1{color:#00f2ea;border-left:4px solid #00f2ea;padding-left:15px;margin-bottom:30px}.logout-bar{display:flex;justify-content:space-between;align-items:center;background:#1a1a1a;padding:10px 20px;border-radius:50px;margin-bottom:20px;border:1px solid #00f2ea40}.logout-btn{background:#ff4444;color:white;border:none;padding:8px 20px;border-radius:50px;cursor:pointer;font-weight:bold;width:auto}.logout-btn:hover{background:#cc0000}.admin-card{background:#111;border:1px solid #2a2a2a;border-radius:16px;padding:25px;margin-bottom:25px;box-shadow:0 8px 0 #050505}h2{color:#00f2ea;margin-bottom:20px;font-size:1.3rem;border-bottom:1px dashed #2e2e2e;padding-bottom:8px}label{display:block;margin:15px 0 5px;color:#aaa;font-size:.9rem;text-transform:uppercase;letter-spacing:1px}input,textarea,select{width:100%;padding:12px;background:#1a1a1a;border:1px solid #3a3a3a;color:#fff;border-radius:8px;font-family:'Courier New',monospace;font-size:.9rem;margin-bottom:10px}input:focus,textarea:focus,select:focus{border-color:#00f2ea;outline:none;box-shadow:0 0 10px #00f2ea66}textarea{min-height:100px;resize:vertical}.checkbox-group{display:flex;align-items:center;gap:10px;margin:20px 0;padding:10px;background:#1a1a1a;border-radius:8px}.checkbox-group input{width:auto;accent-color:#00f2ea}.feature-tags{display:flex;flex-wrap:wrap;gap:10px;margin:20px 0;padding:10px;background:#1a1a1a;border-radius:8px}.feature-tag{background:#1a2a2a;color:#9cfff8;padding:8px 16px;border-radius:30px;font-size:.8rem;border:1px solid #00f2ea40;cursor:pointer;transition:all .2s}.feature-tag:hover{transform:translateY(-2px);border-color:#00f2ea}.feature-tag.selected{background:#00f2ea;color:#000;border-color:#00f2ea;box-shadow:0 0 15px #00f2ea}.key-system-selector{background:#1a2a2a;border-radius:8px;padding:15px;margin:20px 0}.key-option{display:flex;align-items:center;gap:10px;margin:10px 0;padding:12px;background:#0f1a1f;border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent}.key-option:hover{background:#1a2f3a}.key-option.selected{background:#00f2ea20;border:1px solid #00f2ea}.key-option input[type="radio"]{width:auto;accent-color:#00f2ea}.key-badge{padding:4px 12px;border-radius:30px;font-size:.8rem;min-width:80px;text-align:center}.key-badge.keyless{background:#4a4a4a;color:#fff}.key-badge.key1{background:#00aa00;color:#fff}.key-badge.key2{background:#ffaa00;color:#000}.key-badge.key3{background:#ff4444;color:#fff}.linkvertise-config{background:#0f1a2a;border-radius:8px;padding:20px;margin:20px 0;border:1px solid #00f2ea40}.linkvertise-config h3{color:#00f2ea;margin-bottom:15px}.redirect-url-container{background:#1a2a2a;border-radius:8px;padding:20px;margin:10px 0 20px;border:1px solid #ff4444;display:none}.redirect-url-container h3{color:#ff4444;margin-bottom:15px}.redirect-url-container label{color:#ff8888}.image-upload-container{background:#1a2a2a;border-radius:8px;padding:20px;margin:20px 0;border:2px solid #00f2ea}.image-upload-container h3{color:#00f2ea;margin-bottom:15px}.image-preview{width:150px;height:150px;border-radius:12px;background:#0f1a1f;border:2px dashed #00f2ea;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;overflow:hidden;cursor:pointer}.image-preview img{width:100%;height:100%;object-fit:cover}.image-preview span{color:#888;font-size:.9rem;text-align:center}.image-upload-area{background:#0f1a1f;border:2px dashed #00f2ea;border-radius:12px;padding:30px;text-align:center;cursor:pointer;margin-bottom:15px}.image-upload-area:hover{background:#1a2f3a}.image-upload-icon{font-size:3rem;color:#00f2ea;margin-bottom:10px}.image-upload-text{color:#aaa}.image-upload-text strong{color:#00f2ea}.image-url-input{display:flex;gap:10px;margin-top:15px}.image-url-input input{flex:1}.image-url-input button{width:auto;margin:0;padding:12px 25px}.roblox-select-card{background:#1a2f3a;border:2px solid #00f2ea;border-radius:16px;padding:25px;margin:20px 0;box-shadow:0 0 30px #00f2ea33}.roblox-select-card h3{color:#00f2ea;margin-bottom:15px;font-size:1.2rem}.popular-select{width:100%;padding:15px;background:#0f1a1f;border:2px solid #00f2ea;color:#fff;border-radius:10px;margin-bottom:15px;font-size:1rem}.selected-game-preview{background:#1a2a2a;border-radius:12px;padding:20px;margin:20px 0;border:2px solid #00f2ea;display:flex;gap:20px;flex-wrap:wrap}.selected-game-preview img{width:120px;height:120px;border-radius:16px;border:3px solid #00f2ea;object-fit:cover}.selected-game-details{flex:1}.selected-game-details h3{color:#00f2ea;margin-bottom:10px}.selected-game-desc{color:#aaa;margin-bottom:15px;line-height:1.5}.selected-game-stats{display:flex;gap:25px;margin:15px 0;flex-wrap:wrap}.stat-box{background:#0f1a1f;padding:12px 20px;border-radius:10px;border-left:3px solid #00f2ea}.stat-box .label{color:#888;font-size:.8rem}.stat-box .value{color:#00f2ea;font-size:1.2rem;font-weight:bold}.use-game-btn{background:#00f2ea;border:none;padding:15px;border-radius:50px;width:100%;font-weight:bold;cursor:pointer;margin-top:10px}.use-game-btn:hover{background:#00d4cc}.theme-card{background:#1a2f3a;border:2px solid #00f2ea;border-radius:16px;padding:25px;margin:20px 0}.theme-card h3{color:#00f2ea;margin-bottom:15px}.theme-buttons{display:flex;gap:15px;flex-wrap:wrap}.theme-btn{flex:1;min-width:120px;padding:15px;border-radius:50px;font-weight:bold;cursor:pointer;border:none;transition:all .2s}.theme-btn.christmas{background:linear-gradient(135deg,#ff0000,#00ff00);color:white}.theme-btn.halloween{background:linear-gradient(135deg,#ff6600,#6600ff);color:white}.theme-btn.valentine{background:linear-gradient(135deg,#ff69b4,#ff0000);color:white}.theme-btn.default{background:#00f2ea;color:#000}.theme-btn.active{transform:scale(1.05);box-shadow:0 0 20px currentColor}.version-control-card{background:#1a2f3a;border:2px solid #ffaa00;border-radius:16px;padding:25px;margin:20px 0}.version-control-card h3{color:#ffaa00;margin-bottom:15px}.version-list{max-height:200px;overflow-y:auto;background:#0f1a1f;border-radius:8px;padding:10px;margin:10px 0}.version-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #333}.version-item:last-child{border-bottom:none}.version-item.current{background:#ffaa0020;border-left:3px solid #ffaa00}.version-changes{color:#aaa;font-size:.8rem;margin-top:5px}.shortlink-card{background:#1a2f3a;border:2px solid #00f2ea;border-radius:16px;padding:25px;margin:20px 0}.shortlink-card h3{color:#00f2ea;margin-bottom:15px}.shortlink-input{display:flex;gap:10px;margin-bottom:10px}.shortlink-input input{flex:2}.shortlink-input button{width:auto;margin:0}.shortlink-display{background:#0f1a1f;border-radius:8px;padding:15px;margin-top:10px;word-break:break-all}.shortlink-copy{display:flex;gap:10px;margin-top:10px}.shortlink-copy input{flex:2}.shortlink-copy button{width:auto;margin:0}button{background:#00f2ea;color:#000;border:0;padding:14px 25px;border-radius:50px;font-weight:700;cursor:pointer;font-size:1rem;margin-top:10px;width:100%;transition:all .2s;border:1px solid #4afff0}button:hover{background:#00d4cc;transform:scale(1.02);box-shadow:0 0 20px #00f2ea}button.delete{background:#ff4444;color:#fff;border:1px solid #ff8888;width:auto;padding:8px 15px}button.delete:hover{background:#cc0000}button.edit{background:#ffaa00;color:#000;border:1px solid #ffcc00;width:auto;padding:8px 15px}button.edit:hover{background:#ff8800}.script-item{background:#1a1a1a;border-left:3px solid #00f2ea;padding:15px;margin:15px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.script-info{flex:1}.script-info h3{color:#00f2ea;margin-bottom:5px;font-size:1.1rem;display:flex;align-items:center;gap:10px}.script-thumb{width:40px;height:40px;border-radius:8px;object-fit:cover}.script-info p{color:#888;font-size:.8rem;line-height:1.5;margin:5px 0}.script-meta{display:flex;gap:15px;margin-top:8px;flex-wrap:wrap}.script-actions{display:flex;gap:10px}.status-badge{padding:4px 12px;border-radius:30px;font-size:.7rem;background:#00f2ea20;color:#00f2ea;display:inline-block}.admin-badge{background:#ff4444;color:white;padding:2px 8px;border-radius:30px;font-size:.6rem;margin-left:5px}.roblox-badge{background:#00f2ea;color:#000;padding:2px 8px;border-radius:30px;font-size:.6rem;margin-left:5px;font-weight:bold}.status-message{padding:10px;border-radius:8px;margin-bottom:20px;text-align:center}.edit-mode{background:#ffaa0020;border:2px solid #ffaa00;padding:10px;border-radius:8px;margin-bottom:20px;text-align:center}.edit-mode span{color:#ffaa00;font-weight:bold}

/* Map Styles */
.visitor-marker{background:transparent}.leaflet-popup-content{font-family:'Courier New',monospace}.leaflet-container{background:#1a1a1a !important}.leaflet-control-attribution{display:none}
</style>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head><body>
<div class="container">
  <div class="logout-bar">
    <span>ğŸ”’ <strong>Admin Panel</strong> Â· Script Manager</span>
    <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
  </div>
  
  <!-- STATUS MESSAGE -->
  <div id="statusMessage" style="margin-bottom:20px;"></div>
  
  <!-- EDIT MODE INDICATOR -->
  <div id="editModeIndicator" class="edit-mode" style="display: none;">
    <span>âœï¸ EDIT MODE</span> - You are editing a script
  </div>
  
  <!-- VISITOR MAP CARD -->
  <div class="admin-card" style="margin-top:20px;">
    <h2>ğŸ—ºï¸ Live Visitor Map</h2>
    <p style="color:#aaa; margin-bottom:15px;">Shows where your visitors are connecting from in real-time</p>
    
    <!-- Map Container -->
    <div id="visitorMap" style="height: 400px; width: 100%; border-radius: 12px; border: 2px solid #00f2ea; margin-bottom: 15px;"></div>
    
    <!-- Visitor Stats -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
      <div style="background: #1a2a2a; padding: 15px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; color: #00f2ea;" id="totalMapVisitors">0</div>
        <div style="color: #888; font-size: 12px;">Total Visitors</div>
      </div>
      <div style="background: #1a2a2a; padding: 15px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; color: #00f2ea;" id="uniqueCountries">0</div>
        <div style="color: #888; font-size: 12px;">Countries</div>
      </div>
      <div style="background: #1a2a2a; padding: 15px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; color: #00f2ea;" id="activeNow">0</div>
        <div style="color: #888; font-size: 12px;">Active Now</div>
      </div>
    </div>
  </div>
  
  <!-- SHORT LINK GENERATOR -->
  <div class="shortlink-card">
    <h3>ğŸ”— Short Link Generator</h3>
    <p style="color:#aaa; margin-bottom:15px;">Generate short links for any URL</p>
    
    <div class="shortlink-input">
      <input type="url" id="shortlinkUrl" placeholder="Enter any URL (e.g., https://example.com)">
      <button onclick="generateShortLink()" style="background:#00f2ea;">Generate</button>
    </div>
    
    <div id="shortlinkResult" class="shortlink-display" style="display:none;">
      <strong>Short Link:</strong> <span id="shortlinkResultUrl"></span>
      <div class="shortlink-copy">
        <input type="text" id="shortlinkCopy" readonly>
        <button onclick="copyShortLink()" style="background:#4a4a4a;">Copy</button>
      </div>
    </div>
  </div>
  
  <!-- THEME SELECTOR -->
  <div class="theme-card">
    <h3>ğŸ¨ Seasonal Themes</h3>
    <div class="theme-buttons">
      <button class="theme-btn default" onclick="setTheme('default')" id="theme-default">ğŸŒ Default</button>
      <button class="theme-btn christmas" onclick="setTheme('christmas')" id="theme-christmas">ğŸ„ Christmas</button>
      <button class="theme-btn halloween" onclick="setTheme('halloween')" id="theme-halloween">ğŸƒ Halloween</button>
      <button class="theme-btn valentine" onclick="setTheme('valentine')" id="theme-valentine">â¤ï¸ Valentine</button>
    </div>
  </div>
  
  <!-- VERSION CONTROL -->
  <div class="version-control-card">
    <h3>ğŸ“… Version Control</h3>
    <div class="version-list" id="versionList">
      <p style="color:#666;">No versions yet</p>
    </div>
    <details>
      <summary style="color:#ffaa00; cursor:pointer;">â• Add New Version</summary>
      <div style="margin-top:15px;">
        <input type="text" id="newVersion" placeholder="Version (e.g., 2.0.1)">
        <textarea id="versionChanges" placeholder="Changes (one per line)"></textarea>
        <button onclick="addVersion()" style="background:#ffaa00;">Save Version</button>
      </div>
    </details>
  </div>
  
  <!-- ROBLOX GAME SELECTOR -->
  <div class="roblox-select-card">
    <h3>ğŸ® Roblox Game</h3>
    <select id="popularGameSelect" class="popular-select">
      <option value="">Select a game</option>
      <option value="adoptme">ğŸ¾ Adopt Me!</option>
      <option value="bloxfruit">ğŸ® Blox Fruits</option>
      <option value="mm2">ğŸ”ª Murder Mystery 2</option>
    </select>
    <button onclick="fillPopularGame()" style="background:#00f2ea;">ğŸ“‹ Fill Game</button>
  </div>
  
  <!-- IMAGE UPLOAD -->
  <div class="image-upload-container">
    <h3>ğŸ–¼ï¸ Script Image</h3>
    <div class="image-preview" id="imagePreview" onclick="document.getElementById('imageFile').click()">
      <span>Click to upload</span>
    </div>
    <div class="image-upload-area" onclick="document.getElementById('imageFile').click()">
      <div class="image-upload-icon">ğŸ“</div>
      <div class="image-upload-text">Click to upload or <strong>browse</strong></div>
    </div>
    <input type="file" id="imageFile" accept="image/*" onchange="handleImageUpload()" style="display:none;">
    <div class="image-url-input">
      <input type="url" id="imageUrl" placeholder="https://example.com/image.png">
      <button onclick="previewImageUrl()" style="background:#4a4a4a;">Preview</button>
    </div>
    <button onclick="clearImage()" style="background:#ff4444;">ğŸ—‘ï¸ Clear</button>
    <input type="hidden" id="imageData" value="">
  </div>
  
  <!-- MAIN ADMIN CARD -->
  <div class="admin-card">
    <h2 id="formTitle">ğŸ“ Add New Script</h2>
    <input type="hidden" id="editingScriptId">
    <input type="hidden" id="gameUniverseId" value="">
    
    <label>Script Name</label>
    <input type="text" id="scriptName" placeholder="e.g., ğŸ”ª MURDER MYSTERY 2">

    <label>Script Description</label>
    <textarea id="scriptDescription" placeholder="Describe what this script does..."></textarea>

    <label>Loadstring Code</label>
    <textarea id="scriptCode" placeholder='loadstring(game:HttpGet("URL"))()'></textarea>

    <!-- BLURRED CHECKBOX -->
    <div class="checkbox-group">
      <input type="checkbox" id="scriptBlurred" onchange="toggleRedirectUrlField()">
      <label>ğŸ”’ Require verification (blurred)</label>
    </div>

    <!-- REDIRECT URL -->
    <div id="redirectUrlContainer" class="redirect-url-container">
      <h3>ğŸ”— Redirect URL</h3>
      <label>Enter ANY URL</label>
      <input type="url" id="scriptRedirectUrl" placeholder="https://example.com">
      <p style="color:#ff8888; font-size:0.8rem;">â±ï¸ Users will go through 5s timer â†’ bloxlink.html â†’ this URL</p>
    </div>

    <label>ğŸ”‘ Key System Type</label>
    <div class="key-system-selector">
      <div class="key-option" onclick="selectKeySystem('keyless')" id="keyless-option">
        <input type="radio" name="keySystem" value="keyless" checked><span class="key-badge keyless">ğŸ”“ KEYLESS</span>
      </div>
      <div class="key-option" onclick="selectKeySystem('key1')" id="key1-option">
        <input type="radio" name="keySystem" value="key1"><span class="key-badge key1">ğŸ”‘ 1 KEY</span>
      </div>
      <div class="key-option" onclick="selectKeySystem('key2')" id="key2-option">
        <input type="radio" name="keySystem" value="key2"><span class="key-badge key2">ğŸ”‘ğŸ”‘ 2 KEYS</span>
      </div>
      <div class="key-option" onclick="selectKeySystem('key3')" id="key3-option">
        <input type="radio" name="keySystem" value="key3"><span class="key-badge key3">ğŸ”‘ğŸ”‘ğŸ”‘ 3 KEYS</span>
      </div>
    </div>

    <div id="linkvertiseLinks" style="display:none;">
      <div class="linkvertise-config">
        <h3>ğŸ”— Linkvertise Links</h3>
        <div id="linkvertiseFields"></div>
      </div>
    </div>

    <label>Features</label>
    <div class="feature-tags" id="featureTags">
      <span class="feature-tag" data-feature="ğŸ® Bloxfruit">ğŸ® Bloxfruit</span>
      <span class="feature-tag" data-feature="ğŸ§  Brainrot">ğŸ§  Brainrot</span>
      <span class="feature-tag" data-feature="ğŸŒŠ Tsunami">ğŸŒŠ Tsunami</span>
      <span class="feature-tag" data-feature="âš”ï¸ Rivals">âš”ï¸ Rivals</span>
      <span class="feature-tag" data-feature="ğŸ”« Arsenal">ğŸ”« Arsenal</span>
      <span class="feature-tag" data-feature="ğŸŸ Fisch">ğŸŸ Fisch</span>
      <span class="feature-tag" data-feature="ğŸ¾ Adopt Me">ğŸ¾ Adopt Me</span>
      <span class="feature-tag" data-feature="ğŸŒ± Garden">ğŸŒ± Garden</span>
    </div>

    <button onclick="saveScript()" id="saveButton">ğŸ’¾ Save & Auto-Commit</button>
    <button onclick="cancelEdit()" style="background:#666;margin-top:5px;" id="cancelButton">âœ• Cancel</button>
  </div>

  <!-- CURRENT SCRIPTS LIST -->
  <div class="admin-card">
    <h2>ğŸ“‹ Current Scripts</h2>
    <div id="scriptsList">Loading...</div>
  </div>
</div>

<script>
// ==================== VISITOR MAP ====================
let map = null;
let mapMarkers = [];

// Initialize the map
function initVisitorMap() {
  if (!document.getElementById('visitorMap')) return;
  
  // Create map centered on world view
  map = L.map('visitorMap').setView([20, 0], 2);
  
  // Add dark theme tile layer
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);
  
  // Load visitor data
  loadVisitorMapData();
  
  // Refresh every 60 seconds
  setInterval(loadVisitorMapData, 60000);
}

// Load visitor data
function loadVisitorMapData() {
  try {
    // Get online users
    const onlineUsers = JSON.parse(localStorage.getItem('onlineUsers') || '{}');
    document.getElementById('activeNow').textContent = Object.keys(onlineUsers).length;
    
    // Get visitor history
    let visitors = JSON.parse(localStorage.getItem('visitorHistory') || '[]');
    
    // Generate sample data if none exists
    if (visitors.length === 0) {
      visitors = generateSampleVisitors();
      localStorage.setItem('visitorHistory', JSON.stringify(visitors));
    }
    
    // Update counters
    document.getElementById('totalMapVisitors').textContent = visitors.length;
    
    // Count unique countries
    const countries = new Set(visitors.map(v => v.country));
    document.getElementById('uniqueCountries').textContent = countries.size;
    
    // Clear existing markers
    if (mapMarkers.length > 0) {
      mapMarkers.forEach(marker => map.removeLayer(marker));
      mapMarkers = [];
    }
    
    // Add markers
    visitors.forEach(visitor => addVisitorMarker(visitor));
    
  } catch (e) {
    console.error('Map error:', e);
  }
}

// Add marker
function addVisitorMarker(visitor) {
  if (!visitor.lat || !visitor.lng) return;
  
  const isOnline = visitor.lastSeen > Date.now() - 120000;
  
  const icon = L.divIcon({
    html: `<div style="
      width: 16px;
      height: 16px;
      background: ${isOnline ? '#00f2ea' : '#4a4a4a'};
      border: 2px solid ${isOnline ? '#00f2ea' : '#666'};
      border-radius: 50%;
      box-shadow: 0 0 10px ${isOnline ? '#00f2ea' : 'transparent'};
    "></div>`,
    className: '',
    iconSize: [16, 16],
    iconAnchor: [8, 8]
  });
  
  const popup = L.popup().setContent(`
    <div style="color:#333;">
      <b>${visitor.city || 'Unknown'}</b><br>
      ${visitor.country || 'Unknown'}<br>
      <small>${new Date(visitor.lastSeen).toLocaleString()}</small><br>
      <small style="color:${isOnline ? '#00aa00' : '#888'};">${isOnline ? 'â— Online' : 'â—‹ Offline'}</small>
    </div>
  `);
  
  const marker = L.marker([visitor.lat, visitor.lng], { icon }).bindPopup(popup);
  marker.addTo(map);
  mapMarkers.push(marker);
}

// Generate sample visitors
function generateSampleVisitors() {
  const locations = [
    { city: 'New York', country: 'USA', lat: 40.7128, lng: -74.0060 },
    { city: 'London', country: 'UK', lat: 51.5074, lng: -0.1278 },
    { city: 'Tokyo', country: 'Japan', lat: 35.6762, lng: 139.6503 },
    { city: 'Sydney', country: 'Australia', lat: -33.8688, lng: 151.2093 },
    { city: 'SÃ£o Paulo', country: 'Brazil', lat: -23.5505, lng: -46.6333 },
    { city: 'Cape Town', country: 'South Africa', lat: -33.9249, lng: 18.4241 },
    { city: 'Mumbai', country: 'India', lat: 19.0760, lng: 72.8777 },
    { city: 'Moscow', country: 'Russia', lat: 55.7558, lng: 37.6173 },
    { city: 'Dubai', country: 'UAE', lat: 25.2048, lng: 55.2708 },
    { city: 'Singapore', country: 'Singapore', lat: 1.3521, lng: 103.8198 }
  ];
  
  const visitors = [];
  const count = Math.floor(Math.random() * 15) + 10;
  
  for (let i = 0; i < count; i++) {
    const loc = locations[Math.floor(Math.random() * locations.length)];
    visitors.push({
      ...loc,
      lastSeen: Date.now() - Math.random() * 3600000 * 24
    });
  }
  return visitors;
}

// Track actual visitor
function trackVisitorLocation() {
  fetch('https://ipapi.co/json/')
    .then(r => r.json())
    .then(data => {
      if (data.latitude && data.longitude) {
        const visitor = {
          lat: data.latitude,
          lng: data.longitude,
          city: data.city,
          country: data.country_name,
          lastSeen: Date.now()
        };
        
        let history = JSON.parse(localStorage.getItem('visitorHistory') || '[]');
        
        // Don't add duplicate in last hour
        const recent = history.filter(v => 
          v.lat === visitor.lat && 
          v.lng === visitor.lng && 
          v.lastSeen > Date.now() - 3600000
        );
        
        if (recent.length === 0) {
          history.push(visitor);
          if (history.length > 100) history.shift();
          localStorage.setItem('visitorHistory', JSON.stringify(history));
        }
      }
    })
    .catch(() => {});
}

// ==================== AUTH CHECK ====================
async function checkAuth() {
  try {
    const response = await fetch('/api/verify');
    const data = await response.json();
    if (!data.authenticated) {
      window.location.href = '/login.html';
    }
  } catch {
    window.location.href = '/login.html';
  }
}

// ==================== LOGOUT ====================
async function logout() {
  await fetch('/api/logout', { method: 'POST' });
  window.location.href = '/login.html';
}

// ==================== SHORT LINK FUNCTIONS ====================
async function generateShortLink() {
  const url = document.getElementById('shortlinkUrl').value.trim();
  if (!url) { alert('Enter a URL'); return; }
  
  try {
    const response = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(url)}`);
    if (!response.ok) throw new Error('Failed');
    const shortUrl = await response.text();
    
    document.getElementById('shortlinkResultUrl').textContent = shortUrl;
    document.getElementById('shortlinkCopy').value = shortUrl;
    document.getElementById('shortlinkResult').style.display = 'block';
    showStatus('âœ… Short link generated!');
  } catch (e) {
    document.getElementById('shortlinkResultUrl').textContent = url;
    document.getElementById('shortlinkCopy').value = url;
    document.getElementById('shortlinkResult').style.display = 'block';
    showStatus('âš ï¸ Using original URL', true);
  }
}

function copyShortLink() {
  const input = document.getElementById('shortlinkCopy');
  input.select();
  navigator.clipboard.writeText(input.value).then(() => {
    showStatus('âœ… Copied!');
  });
}

// ==================== THEME FUNCTIONS ====================
function setTheme(theme) {
  document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`theme-${theme}`).classList.add('active');
  showStatus(`âœ… Theme set to ${theme}`);
}

// ==================== VERSION CONTROL ====================
function addVersion() {
  const version = document.getElementById('newVersion').value;
  const changes = document.getElementById('versionChanges').value;
  if (!version || !changes) { alert('Enter both fields'); return; }
  showStatus('âœ… Version added');
  document.getElementById('newVersion').value = '';
  document.getElementById('versionChanges').value = '';
}

// ==================== IMAGE FUNCTIONS ====================
function handleImageUpload() {
  const file = document.getElementById('imageFile').files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}">`;
    document.getElementById('imageData').value = e.target.result;
  };
  reader.readAsDataURL(file);
}

function previewImageUrl() {
  const url = document.getElementById('imageUrl').value;
  if (!url) return;
  document.getElementById('imagePreview').innerHTML = `<img src="${url}">`;
  document.getElementById('imageData').value = url;
}

function clearImage() {
  document.getElementById('imagePreview').innerHTML = '<span>Click to upload</span>';
  document.getElementById('imageData').value = '';
  document.getElementById('imageUrl').value = '';
}

// ==================== ROBLOX GAME ====================
const popularGames = {
  adoptme: { name: "ğŸ¾ Adopt Me!", universeId: "3373681961", description: "Adopt and raise pets!", thumbUrl: "https://tr.rbxcdn.com/180DAY-92700ae9fa80f96ce2436f4d8760a9e2/256/256/Image/Webp/noFilter" },
  bloxfruit: { name: "ğŸ® Blox Fruits", universeId: "4520749081", description: "Become a master of Blox Fruits!", thumbUrl: "https://tr.rbxcdn.com/180DAY-2f74f0b0b8a847bb39fd8745a8228f5b/256/256/Image/Webp/noFilter" },
  mm2: { name: "ğŸ”ª Murder Mystery 2", universeId: "142823291", description: "A classic game of mystery!", thumbUrl: "https://tr.rbxcdn.com/180DAY-c8a3f0c68489fcc7f4b56772b5778a96/256/256/Image/Webp/noFilter" }
};

function fillPopularGame() {
  const gameKey = document.getElementById('popularGameSelect').value;
  if (!gameKey) return;
  const game = popularGames[gameKey];
  
  document.getElementById('scriptName').value = game.name;
  document.getElementById('scriptDescription').value = game.description;
  document.getElementById('imageUrl').value = game.thumbUrl;
  document.getElementById('imageData').value = game.thumbUrl;
  document.getElementById('imagePreview').innerHTML = `<img src="${game.thumbUrl}">`;
  document.getElementById('gameUniverseId').value = game.universeId;
  showStatus('âœ… Game loaded');
}

// ==================== UI FUNCTIONS ====================
function showStatus(msg, isError) {
  const el = document.getElementById('statusMessage');
  el.innerHTML = `<div style="background:${isError?'#ff444420':'#00f2ea20'};border:1px solid ${isError?'#ff4444':'#00f2ea'};color:${isError?'#ff8888':'#00f2ea'};padding:10px;border-radius:8px;">${msg}</div>`;
  setTimeout(() => el.innerHTML = '', 3000);
}

function toggleRedirectUrlField() {
  const c = document.getElementById('scriptBlurred').checked;
  document.getElementById('redirectUrlContainer').style.display = c ? 'block' : 'none';
}

function selectKeySystem(v) {
  selectedKeySystem = v;
  document.querySelectorAll('.key-option').forEach(o => o.classList.remove('selected'));
  document.getElementById(v+'-option').classList.add('selected');
  
  const div = document.getElementById('linkvertiseLinks');
  const fields = document.getElementById('linkvertiseFields');
  if (v !== 'keyless') {
    div.style.display = 'block';
    let html = '';
    for (let i = 1; i <= parseInt(v.replace('key','')); i++) {
      html += `<label>Key ${i} URL</label><input type="url" id="key${i}Link" placeholder="https://example.com">`;
    }
    fields.innerHTML = html;
  } else div.style.display = 'none';
}

// ==================== FEATURE TAGS ====================
document.querySelectorAll('.feature-tag').forEach(t => {
  t.onclick = () => {
    t.classList.toggle('selected');
    const f = t.dataset.feature;
    if (selectedFeatures.includes(f)) {
      selectedFeatures = selectedFeatures.filter(x => x !== f);
    } else {
      selectedFeatures.push(f);
    }
  };
});

// ==================== STATE ====================
let selectedFeatures = [], currentScripts = [], selectedKeySystem = 'keyless';

// ==================== CANCEL EDIT ====================
function cancelEdit() {
  document.getElementById('scriptName').value = '';
  document.getElementById('scriptDescription').value = '';
  document.getElementById('scriptCode').value = '';
  document.getElementById('scriptBlurred').checked = false;
  document.getElementById('scriptRedirectUrl').value = '';
  document.getElementById('editingScriptId').value = '';
  document.getElementById('gameUniverseId').value = '';
  document.getElementById('redirectUrlContainer').style.display = 'none';
  document.getElementById('formTitle').innerHTML = 'ğŸ“ Add New Script';
  document.getElementById('saveButton').innerHTML = 'ğŸ’¾ Save & Auto-Commit';
  document.getElementById('editModeIndicator').style.display = 'none';
  clearImage();
  
  selectedKeySystem = 'keyless';
  document.querySelectorAll('.key-option').forEach(o => o.classList.remove('selected'));
  document.getElementById('keyless-option').classList.add('selected');
  selectedFeatures = [];
  document.querySelectorAll('.feature-tag').forEach(t => t.classList.remove('selected'));
  document.getElementById('linkvertiseLinks').style.display = 'none';
}

// ==================== LOAD SCRIPTS ====================
async function loadScripts() {
  try {
    const r = await fetch('scripts.json?t='+Date.now());
    const d = await r.json();
    currentScripts = d.scripts || [];
    
    const list = document.getElementById('scriptsList');
    if (!currentScripts.length) { list.innerHTML = '<p>No scripts</p>'; return; }
    
    list.innerHTML = currentScripts.map(s => {
      let key = '';
      if (s.keySystem === 'key1') key = '<span class="key-badge key1">ğŸ”‘1</span>';
      else if (s.keySystem === 'key2') key = '<span class="key-badge key2">ğŸ”‘ğŸ”‘2</span>';
      else if (s.keySystem === 'key3') key = '<span class="key-badge key3">ğŸ”‘ğŸ”‘ğŸ”‘3</span>';
      
      let thumbnail = s.image ? `<img src="${s.image}" class="script-thumb">` : '';
      
      return `<div class="script-item">
        <div class="script-info">
          <h3>${thumbnail} ${s.name}</h3>
          ${s.description ? `<p>ğŸ“ ${s.description.substring(0,100)}...</p>` : ''}
          <div class="script-meta">
            <span class="status-badge">${s.blurred?'ğŸ”’Blurred':'âœ…Public'}</span>
            ${key}
          </div>
        </div>
        <div class="script-actions">
          <button class="edit" onclick="editScript('${s.id}')">âœï¸</button>
          <button class="delete" onclick="deleteScript('${s.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`;
    }).join('');
  } catch(e) { 
    document.getElementById('scriptsList').innerHTML = '<p style="color:#ff4444;">Error loading scripts</p>';
  }
}

// ==================== EDIT SCRIPT ====================
function editScript(id) {
  const s = currentScripts.find(x => x.id === id);
  if (!s) return;
  
  document.getElementById('scriptName').value = s.name;
  document.getElementById('scriptDescription').value = s.description || '';
  document.getElementById('scriptCode').value = s.code;
  document.getElementById('scriptBlurred').checked = s.blurred || false;
  document.getElementById('scriptRedirectUrl').value = s.redirectUrl || '';
  document.getElementById('editingScriptId').value = s.id;
  document.getElementById('gameUniverseId').value = s.universeId || '';
  
  if (s.image) {
    document.getElementById('imagePreview').innerHTML = `<img src="${s.image}">`;
    document.getElementById('imageData').value = s.image;
  }
  
  document.getElementById('redirectUrlContainer').style.display = s.blurred ? 'block' : 'none';
  
  selectKeySystem(s.keySystem || 'keyless');
  selectedFeatures = s.features || [];
  document.querySelectorAll('.feature-tag').forEach(t => {
    t.classList.toggle('selected', selectedFeatures.includes(t.dataset.feature));
  });
  
  if (s.keyLinks) {
    for (let i = 1; i <= s.keyLinks.length; i++) {
      const inp = document.getElementById(`key${i}Link`);
      if (inp) inp.value = s.keyLinks[i-1];
    }
  }
  
  document.getElementById('formTitle').innerHTML = 'âœï¸ Edit Script';
  document.getElementById('saveButton').innerHTML = 'âœï¸ Update & Auto-Commit';
  document.getElementById('editModeIndicator').style.display = 'block';
}

// ==================== SAVE SCRIPT ====================
async function saveScript() {
  const name = document.getElementById('scriptName').value;
  const description = document.getElementById('scriptDescription').value;
  const code = document.getElementById('scriptCode').value;
  const blurred = document.getElementById('scriptBlurred').checked;
  const redirect = document.getElementById('scriptRedirectUrl').value;
  const editId = document.getElementById('editingScriptId').value;
  const image = document.getElementById('imageData').value;
  const universeId = document.getElementById('gameUniverseId').value;
  
  if (!name || !code) { alert('Fill all fields'); return; }
  if (blurred && !redirect) { alert('Redirect URL required for blurred scripts'); return; }
  
  let keyLinks = [];
  if (selectedKeySystem !== 'keyless') {
    for (let i = 1; i <= parseInt(selectedKeySystem.replace('key','')); i++) {
      const link = document.getElementById(`key${i}Link`)?.value;
      if (!link) { alert(`Enter Key ${i} URL`); return; }
      keyLinks.push(link);
    }
  }
  
  const scriptData = {
    id: editId || name.toLowerCase().replace(/[^a-z0-9]/g,'') + Date.now(),
    name, description, code, blurred, redirectUrl: redirect,
    image: image || null,
    universeId: universeId || null,
    keySystem: selectedKeySystem, keyLinks, features: [...selectedFeatures]
  };
  
  if (editId) {
    const idx = currentScripts.findIndex(s => s.id === editId);
    if (idx !== -1) currentScripts[idx] = scriptData;
  } else {
    currentScripts.push(scriptData);
  }
  
  showStatus(`âœ… ${editId ? 'Updated' : 'Added'}!`);
  loadScripts();
  cancelEdit();
}

// ==================== DELETE SCRIPT ====================
async function deleteScript(id) {
  if (!confirm('Delete this script?')) return;
  
  currentScripts = currentScripts.filter(s => s.id !== id);
  showStatus('âœ… Deleted!');
  loadScripts();
}

// ==================== INIT ====================
checkAuth();
loadScripts();

// Track visitor location for map
trackVisitorLocation();

// Initialize map when page loads
window.addEventListener('load', function() {
  setTimeout(initVisitorMap, 1000);
});
</script></body></html>
