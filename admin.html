<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin - Script Manager</title><style>
*{box-sizing:border-box;margin:0}body{background:#0b0b0b;color:#eaeaea;font-family:'Courier New',monospace;padding:20px}.container{max-width:800px;margin:0 auto}h1{color:#00f2ea;border-left:4px solid #00f2ea;padding-left:15px;margin-bottom:30px}.admin-card{background:#111;border:1px solid #2a2a2a;border-radius:16px;padding:25px;margin-bottom:25px}h2{color:#00f2ea;margin-bottom:20px;font-size:1.3rem}label{display:block;margin:15px 0 5px;color:#aaa;font-size:.9rem}input,textarea,select{width:100%;padding:12px;background:#1a1a1a;border:1px solid #3a3a3a;color:#fff;border-radius:8px;font-family:inherit}input:focus,textarea:focus,select:focus{border-color:#00f2ea;outline:0}textarea{min-height:100px;font-size:.8rem}.checkbox-group{display:flex;align-items:center;gap:10px;margin:15px 0}.checkbox-group input{width:auto}.feature-tags{display:flex;flex-wrap:wrap;gap:10px;margin:15px 0}.feature-tag{background:#1a2a2a;color:#9cfff8;padding:5px 12px;border-radius:30px;font-size:.8rem;border:1px solid #00f2ea40;cursor:pointer}.feature-tag.selected{background:#00f2ea;color:#000;border-color:#00f2ea}button{background:#00f2ea;color:#000;border:0;padding:14px 25px;border-radius:50px;font-weight:700;cursor:pointer;font-size:1rem;margin-top:10px;width:100%}button:hover{background:#00d4cc}button.delete{background:#ff4444;color:#fff}button.delete:hover{background:#cc0000}button.edit{background:#ffaa00;color:#000}button.edit:hover{background:#ff8800}.script-item{background:#1a1a1a;border-left:3px solid #00f2ea;padding:15px;margin:15px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.script-info h3{color:#00f2ea;margin-bottom:5px}.script-info p{color:#888;font-size:.8rem}.script-actions{display:flex;gap:10px}.script-actions button{width:auto;padding:8px 15px;margin:0;font-size:.8rem}.update-note{background:#1a2a3a;border:1px solid #00f2ea;border-radius:8px;padding:15px;margin:20px 0;color:#fff;font-size:.9rem;text-align:center}.update-note strong{color:#00f2ea}.key-system-selector{background:#1a2a2a;border-radius:8px;padding:15px;margin:15px 0}.key-option{display:flex;align-items:center;gap:10px;margin:10px 0;padding:10px;background:#0f1a1f;border-radius:8px;cursor:pointer}.key-option input[type="radio"]{width:auto;margin-right:10px}.key-option.selected{background:#00f2ea20;border:1px solid #00f2ea}.key-badge{padding:4px 12px;border-radius:30px;font-size:.8rem;font-weight:bold}.key-badge.keyless{background:#4a4a4a;color:#fff}.key-badge.key1{background:#00aa00;color:#fff}.key-badge.key2{background:#ffaa00;color:#000}.key-badge.key3{background:#ff4444;color:#fff}.linkvertise-config{background:#0f1a2a;border-radius:8px;padding:15px;margin:15px 0;border:1px solid #00f2ea40}.linkvertise-config h3{color:#00f2ea;font-size:1rem;margin-bottom:10px}.redirect-url-container{background:#1a2a2a;border-radius:8px;padding:15px;margin:15px 0;border:1px solid #00f2ea;display:none}.redirect-url-container h3{color:#00f2ea;font-size:1rem;margin-bottom:10px}.edit-mode{background:#ffaa0020;border:2px solid #ffaa00;padding:10px;border-radius:8px;margin-bottom:20px;text-align:center}.edit-mode span{color:#ffaa00;font-weight:bold}.warning{background:#ffaa0020;border:1px solid #ffaa00;color:#ffaa00;padding:10px;border-radius:8px;margin:10px 0;font-size:.9rem}.token-success{background:#00aa0020;border:1px solid #00aa00;color:#00aa00;padding:10px;border-radius:8px;margin:10px 0;font-size:.9rem}
</style></head><body><div class="container"><h1>ğŸ”§ Script Manager Admin</h1>

<!-- GITHUB TOKEN SETUP INSTRUCTION -->
<div class="warning" id="tokenWarning">
  <strong>âš ï¸ ACTION REQUIRED:</strong> Set your GitHub token below
</div>

<div id="tokenSuccess" class="token-success" style="display:none;">
  <strong>âœ… Token Valid!</strong> GitHub connection working
</div>

<!-- TOKEN SETUP CARD -->
<div class="admin-card">
  <h2>ğŸ”‘ GitHub Token Setup</h2>
  <p style="margin-bottom:10px;">1. Go to: <a href="https://github.com/settings/tokens" target="_blank" style="color:#00f2ea;">github.com/settings/tokens</a></p>
  <p style="margin-bottom:10px;">2. Click "Generate new token (classic)"</p>
  <p style="margin-bottom:10px;">3. Select scope: <strong style="color:#00f2ea;">repo</strong> (full control)</p>
  <p style="margin-bottom:10px;">4. Copy the token (starts with <code>ghp_</code>)</p>
  
  <label>Paste your GitHub token here:</label>
  <input type="password" id="githubTokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="margin-bottom:10px;">
  <button onclick="saveToken()" style="background:#00f2ea;">ğŸ’¾ Save Token</button>
  <button onclick="testToken()" style="background:#4a4a4a; margin-top:5px;">ğŸ” Test Token</button>
</div>

<div class="admin-card">
  <h2>ğŸ“ <span id="formTitle">Add New Script</span></h2>
  
  <input type="hidden" id="editingScriptId" value="">
  
  <label>Script Name (with emoji)</label>
  <input type="text" id="scriptName" placeholder="e.g., ğŸ”ª NEW GAME">

  <label>Loadstring Code</label>
  <textarea id="scriptCode" placeholder='loadstring(game:HttpGet("URL"))()'></textarea>

  <div class="checkbox-group">
    <input type="checkbox" id="scriptBlurred" onchange="toggleRedirectUrlField()">
    <label>ğŸ”’ Require verification (blurred)</label>
  </div>

  <div id="redirectUrlContainer" class="redirect-url-container">
    <h3>ğŸ”— Redirect Settings</h3>
    <label>Destination URL (after 5 seconds)</label>
    <input type="url" id="scriptRedirectUrl" placeholder="https://openinapp.link/xxx">
  </div>

  <label>ğŸ”‘ Key System Type</label>
  <div class="key-system-selector">
    <div class="key-option" onclick="selectKeySystem('keyless')" id="keyless-option">
      <input type="radio" name="keySystem" value="keyless" checked> 
      <span class="key-badge keyless">ğŸ”“ KEYLESS</span>
    </div>
    <div class="key-option" onclick="selectKeySystem('key1')" id="key1-option">
      <input type="radio" name="keySystem" value="key1"> 
      <span class="key-badge key1">ğŸ”‘ 1 KEY</span>
    </div>
    <div class="key-option" onclick="selectKeySystem('key2')" id="key2-option">
      <input type="radio" name="keySystem" value="key2"> 
      <span class="key-badge key2">ğŸ”‘ğŸ”‘ 2 KEYS</span>
    </div>
    <div class="key-option" onclick="selectKeySystem('key3')" id="key3-option">
      <input type="radio" name="keySystem" value="key3"> 
      <span class="key-badge key3">ğŸ”‘ğŸ”‘ğŸ”‘ 3 KEYS</span>
    </div>
  </div>

  <div id="linkvertiseLinks" style="display:none;">
    <div class="linkvertise-config">
      <h3>ğŸ”— Linkvertise Links (User ID: 1446949)</h3>
      <div id="linkvertiseFields"></div>
    </div>
  </div>

  <label>Features</label>
  <div class="feature-tags" id="featureTags">
    <span class="feature-tag" data-feature="ğŸ® Bloxfruit">ğŸ® Bloxfruit</span>
    <span class="feature-tag" data-feature="ğŸ§  Brainrot">ğŸ§  Brainrot</span>
    <span class="feature-tag" data-feature="ğŸŒŠ Tsunami">ğŸŒŠ Tsunami</span>
    <span class="feature-tag" data-feature="âš”ï¸ Rivals">âš”ï¸ Rivals</span>
    <span class="feature-tag" data-feature="ğŸ”« Arsenal">ğŸ”« Arsenal</span>
    <span class="feature-tag" data-feature="ğŸŸ Fisch">ğŸŸ Fisch</span>
    <span class="feature-tag" data-feature="ğŸ¾ Adopt Me">ğŸ¾ Adopt Me</span>
    <span class="feature-tag" data-feature="ğŸŒ± Garden">ğŸŒ± Garden</span>
  </div>

  <div style="display: flex; gap: 10px;">
    <button onclick="saveScript()" style="flex: 2;" id="saveButton">ğŸ’¾ Save & Auto-Commit</button>
    <button onclick="cancelEdit()" style="flex: 1; background: #666;" id="cancelButton">âœ• Cancel</button>
  </div>
</div>

<div class="admin-card">
  <h2>ğŸ“‹ Current Scripts</h2>
  <div id="scriptsList">
    <p style="color:#666;">Loading scripts...</p>
  </div>
</div></div>

<script>
// ==================== GITHUB CONFIGURATION ====================
let GITHUB_TOKEN = localStorage.getItem('github_token') || '';
const REPO_OWNER = 'dikilia';
const REPO_NAME = 'lokus-hub';
const FILE_PATH = 'scripts.json';

// ==================== SAVE TOKEN ====================
function saveToken() {
    const token = document.getElementById('githubTokenInput').value.trim();
    if (!token || !token.startsWith('ghp_')) {
        alert('âŒ Invalid token format. Token should start with "ghp_"');
        return;
    }
    GITHUB_TOKEN = token;
    localStorage.setItem('github_token', token);
    document.getElementById('tokenWarning').style.display = 'none';
    testToken();
}

// ==================== TEST TOKEN ====================
async function testToken() {
    if (!GITHUB_TOKEN) {
        alert('Please enter your GitHub token first');
        return false;
    }
    
    try {
        const response = await fetch('https://api.github.com/user', {
            headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… Token works! User:', data.login);
        document.getElementById('tokenSuccess').style.display = 'block';
        document.getElementById('tokenWarning').style.display = 'none';
        alert(`âœ… Token valid! Logged in as: ${data.login}`);
        return true;
        
    } catch (error) {
        console.error('âŒ Token error:', error);
        document.getElementById('tokenSuccess').style.display = 'none';
        document.getElementById('tokenWarning').style.display = 'block';
        alert('âŒ Token invalid! Make sure you have "repo" scope selected.');
        return false;
    }
}

// ==================== ANTI-DEBUG ====================
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || 
      (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'U')) {
    e.preventDefault();
  }
});

// ==================== STATE ====================
let selectedFeatures = [];
let currentScripts = [];
let selectedKeySystem = 'keyless';
const LINKVERTISE_USER_ID = '1446949';
const CALLBACK_URL = 'https://linkvertise-callback-production.up.railway.app/callback';

// ==================== TOGGLE REDIRECT FIELD ====================
function toggleRedirectUrlField() {
  const blurred = document.getElementById('scriptBlurred').checked;
  document.getElementById('redirectUrlContainer').style.display = blurred ? 'block' : 'none';
  if (!blurred) document.getElementById('scriptRedirectUrl').value = '';
}

// ==================== KEY SYSTEM ====================
function selectKeySystem(value) {
  selectedKeySystem = value;
  document.querySelectorAll('.key-option').forEach(opt => opt.classList.remove('selected'));
  document.getElementById(value + '-option').classList.add('selected');
  document.querySelector(`input[name="keySystem"][value="${value}"]`).checked = true;
  
  const linkvertiseDiv = document.getElementById('linkvertiseLinks');
  const fieldsDiv = document.getElementById('linkvertiseFields');
  
  if (value !== 'keyless') {
    linkvertiseDiv.style.display = 'block';
    const numKeys = parseInt(value.replace('key', ''));
    let html = '';
    for (let i = 1; i <= numKeys; i++) {
      html += `<label>Key ${i} Linkvertise URL</label><input type="url" id="key${i}Link" placeholder="https://link-to.net/1446949/123456/dynamic">`;
    }
    fieldsDiv.innerHTML = html;
  } else {
    linkvertiseDiv.style.display = 'none';
  }
}

// ==================== FEATURE TAGS ====================
document.querySelectorAll('.feature-tag').forEach(tag => {
  tag.addEventListener('click', function() {
    this.classList.toggle('selected');
    const feature = this.dataset.feature;
    if (selectedFeatures.includes(feature)) {
      selectedFeatures = selectedFeatures.filter(f => f !== feature);
    } else {
      selectedFeatures.push(feature);
    }
  });
});

// ==================== CANCEL EDIT ====================
function cancelEdit() {
  document.getElementById('scriptName').value = '';
  document.getElementById('scriptCode').value = '';
  document.getElementById('scriptBlurred').checked = false;
  document.getElementById('scriptRedirectUrl').value = '';
  document.getElementById('editingScriptId').value = '';
  document.getElementById('redirectUrlContainer').style.display = 'none';
  document.getElementById('formTitle').textContent = 'Add New Script';
  document.getElementById('saveButton').textContent = 'ğŸ’¾ Save & Auto-Commit';
  document.getElementById('editModeIndicator').style.display = 'none';
  
  selectedKeySystem = 'keyless';
  document.querySelectorAll('.key-option').forEach(opt => opt.classList.remove('selected'));
  document.getElementById('keyless-option').classList.add('selected');
  document.querySelector('input[name="keySystem"][value="keyless"]').checked = true;
  
  selectedFeatures = [];
  document.querySelectorAll('.feature-tag').forEach(t => t.classList.remove('selected'));
  document.getElementById('linkvertiseLinks').style.display = 'none';
}

// ==================== LOAD SCRIPTS ====================
async function loadScripts() {
  try {
    const response = await fetch('scripts.json?t=' + Date.now());
    const data = await response.json();
    currentScripts = data.scripts || [];
    displayScripts();
  } catch (error) {
    console.error('Failed to load scripts:', error);
    document.getElementById('scriptsList').innerHTML = '<p style="color: #ff4444;">âŒ No scripts.json found</p>';
  }
}

// ==================== DISPLAY SCRIPTS ====================
function displayScripts() {
  const list = document.getElementById('scriptsList');
  if (currentScripts.length === 0) {
    list.innerHTML = '<p style="color: #666;">No scripts yet</p>';
    return;
  }
  
  list.innerHTML = currentScripts.map(script => {
    let keyDisplay = '';
    if (script.keySystem === 'keyless') keyDisplay = '<span class="key-badge keyless">ğŸ”“ KEYLESS</span>';
    else if (script.keySystem === 'key1') keyDisplay = '<span class="key-badge key1">ğŸ”‘ 1 KEY</span>';
    else if (script.keySystem === 'key2') keyDisplay = '<span class="key-badge key2">ğŸ”‘ğŸ”‘ 2 KEYS</span>';
    else if (script.keySystem === 'key3') keyDisplay = '<span class="key-badge key3">ğŸ”‘ğŸ”‘ğŸ”‘ 3 KEYS</span>';
    
    return `
    <div class="script-item">
      <div class="script-info">
        <h3>${script.name}</h3>
        <p>${script.code.substring(0, 50)}...</p>
        <p style="display:flex; gap:5px; flex-wrap:wrap;">
          ${script.blurred ? 'ğŸ”’ Requires verification' : 'âœ… Public'} | 
          Features: ${script.features?.length || 0} |
          ${keyDisplay}
          ${script.redirectUrl ? ' | ğŸ”— Has redirect' : ''}
        </p>
      </div>
      <div class="script-actions">
        <button onclick="editScript('${script.id}')" class="edit">âœï¸</button>
        <button onclick="deleteScript('${script.id}')" class="delete">ğŸ—‘ï¸</button>
      </div>
    </div>
  `}).join('');
}

// ==================== EDIT SCRIPT ====================
function editScript(id) {
  const script = currentScripts.find(s => s.id === id);
  if (!script) return;
  
  document.getElementById('scriptName').value = script.name;
  document.getElementById('scriptCode').value = script.code;
  document.getElementById('scriptBlurred').checked = script.blurred || false;
  document.getElementById('scriptRedirectUrl').value = script.redirectUrl || '';
  document.getElementById('editingScriptId').value = script.id;
  
  if (script.blurred) document.getElementById('redirectUrlContainer').style.display = 'block';
  
  selectKeySystem(script.keySystem || 'keyless');
  
  selectedFeatures = script.features || [];
  document.querySelectorAll('.feature-tag').forEach(tag => {
    tag.classList.toggle('selected', selectedFeatures.includes(tag.dataset.feature));
  });
  
  if (script.keyLinks && script.keyLinks.length > 0) {
    for (let i = 1; i <= script.keyLinks.length; i++) {
      const input = document.getElementById(`key${i}Link`);
      if (input) input.value = script.keyLinks[i-1];
    }
  }
  
  document.getElementById('formTitle').textContent = 'Edit Script';
  document.getElementById('saveButton').textContent = 'âœï¸ Update & Auto-Commit';
  document.getElementById('editModeIndicator').style.display = 'block';
  
  document.querySelector('.admin-card').scrollIntoView({ behavior: 'smooth' });
}

// ==================== GITHUB API FUNCTIONS ====================
async function getCurrentFileSha() {
  try {
    const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
      headers: {
        'Authorization': `Bearer ${GITHUB_TOKEN}`,
        'Accept': 'application/vnd.github+json'
      }
    });
    
    if (!response.ok) {
      if (response.status === 404) return null;
      throw new Error(`Error getting SHA: ${response.statusText}`);
    }
    
    const data = await response.json();
    return data.sha;
  } catch (error) {
    console.error('SHA fetch error:', error);
    return null;
  }
}

async function autoCommitToGitHub(scriptData, isEdit = false) {
    if (!GITHUB_TOKEN) {
        alert('âŒ Please enter your GitHub token in the setup card first!');
        return false;
    }
    
    try {
        // Test token first
        const tokenTest = await fetch('https://api.github.com/user', {
            headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` }
        });
        
        if (!tokenTest.ok) {
            throw new Error('Token invalid or missing "repo" scope');
        }
        
        const currentSha = await getCurrentFileSha();
        
        const fullData = {
            siteTitle: "lokus hub scripts",
            visitorCount: 1842,
            linkvertise: {
                userId: LINKVERTISE_USER_ID,
                callbackUrl: CALLBACK_URL
            },
            scripts: currentScripts,
            lastUpdated: new Date().toISOString().split('T')[0]
        };
        
        const contentStr = JSON.stringify(fullData, null, 2);
        const encodedContent = btoa(unescape(encodeURIComponent(contentStr)));
        
        const requestBody = {
            message: isEdit ? `âœï¸ Updated script: ${scriptData.name}` : `âœ¨ Added new script: ${scriptData.name}`,
            content: encodedContent,
            sha: currentSha
        };
        
        const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 401 || response.status === 403) {
                throw new Error('Token lacks "repo" scope - please regenerate with repo selected');
            } else if (response.status === 404) {
                throw new Error('Repository not found - check REPO_OWNER and REPO_NAME');
            } else {
                throw new Error(`GitHub API error: ${errorData.message}`);
            }
        }
        
        const result = await response.json();
        console.log('âœ… GitHub update successful:', result.commit.html_url);
        alert(`âœ… Script ${isEdit ? 'updated' : 'added'} successfully!\n\nVercel will auto-deploy in 1-2 minutes.`);
        return true;
        
    } catch (error) {
        console.error('âŒ GitHub commit error:', error);
        alert(`âŒ Failed to commit: ${error.message}\n\nMake sure your token has 'repo' scope.`);
        return false;
    }
}

// ==================== SAVE SCRIPT ====================
function saveScript() {
  const name = document.getElementById('scriptName').value;
  const code = document.getElementById('scriptCode').value;
  const blurred = document.getElementById('scriptBlurred').checked;
  const redirectUrl = document.getElementById('scriptRedirectUrl').value;
  const editingId = document.getElementById('editingScriptId').value;
  
  if (!name || !code) {
    alert('Please fill in all fields');
    return;
  }
  
  if (blurred && !redirectUrl) {
    alert('Please enter a redirect URL for blurred scripts');
    return;
  }
  
  let keyLinks = [];
  if (selectedKeySystem !== 'keyless') {
    const numKeys = parseInt(selectedKeySystem.replace('key', ''));
    for (let i = 1; i <= numKeys; i++) {
      const link = document.getElementById(`key${i}Link`)?.value;
      if (!link) {
        alert(`Please enter Key ${i} Linkvertise URL`);
        return;
      }
      keyLinks.push(link);
    }
  }
  
  const scriptData = {
    id: editingId || name.toLowerCase().replace(/[^a-z0-9]/g, '') + Date.now(),
    name: name,
    code: code,
    blurred: blurred,
    redirectUrl: redirectUrl,
    keySystem: selectedKeySystem,
    keyLinks: keyLinks,
    features: [...selectedFeatures]
  };
  
  if (editingId) {
    const index = currentScripts.findIndex(s => s.id === editingId);
    if (index !== -1) {
      currentScripts[index] = scriptData;
      autoCommitToGitHub(scriptData, true).then(success => {
        if (success) {
          displayScripts();
          cancelEdit();
        }
      });
    }
  } else {
    currentScripts.push(scriptData);
    autoCommitToGitHub(scriptData, false).then(success => {
      if (success) {
        displayScripts();
        cancelEdit();
      }
    });
  }
}

// ==================== DELETE SCRIPT ====================
async function deleteScript(id) {
  let password = prompt('Enter admin password to delete:');
  if (password !== 'noobie123admin') {
    alert('Invalid password!');
    return;
  }
  
  if (!confirm('Delete this script?')) return;
  
  const scriptToDelete = currentScripts.find(s => s.id === id);
  currentScripts = currentScripts.filter(script => script.id !== id);
  
  await autoCommitToGitHub(scriptToDelete, false);
  displayScripts();
}

// ==================== LOAD ON START ====================
loadScripts();

// Check if token exists on load
if (GITHUB_TOKEN) {
    document.getElementById('githubTokenInput').value = GITHUB_TOKEN;
    testToken();
}
</script></body></html>
